---
layout:           default
class:            html
prism:            true
JSONFormatter:    true
ejs:              true
moment:           true
BootstrapSelect:  true
TermJS:           true
marked:           true
---

<style>
#task-not-found {display: none;}
#task-info {display: none;}
.nav.nav-tabs a.tab {
  cursor:         pointer;
}
#taskId {font: normal 10pt 'Courier New';}

.toggle-json {
  cursor: pointer;
}
.toggle-json:hover span.json-label {
  text-decoration: underline;
}
.toggle-json span.label {
  font-size: 50%;
  position: relative;
  top: -5px;
  margin-left: 5px;
}
.toggle-json i.glyphicon {
  font-size: 20px;
}
.toggle-json i.glyphicon:before {
  display:    inline-block;
  -webkit-transition: linear 200ms;
     -moz-transition: linear 200ms;
       -o-transition: linear 200ms;
          transition: linear 200ms;
  -webkit-transform: rotate(-90deg);
     -moz-transform: rotate(-90deg);
      -ms-transform: rotate(-90deg);
       -o-transform: rotate(-90deg);
          transform: rotate(-90deg);
}
.toggle-json i.glyphicon.right:before {
  -webkit-transform: rotate(0deg);
     -moz-transform: rotate(0deg);
      -ms-transform: rotate(0deg);
       -o-transform: rotate(0deg);
          transform: rotate(0deg);
}
.toggle-target {
  display:      none;
}
.link {
  cursor:       pointer;
}
h3 {
  margin-left: 30px;
}
h3.toggle-json {
  margin-left: 0px;
}
#fullscreen-log-viewer .modal-dialog {
  width:        121ex;
}
</style>

<h1>Task Inspector</h1>
<p>This tool lets you inspect a task given the <code>taskId</code></p>

<div class="form-horizontal">
  <div class="form-group">
    <label for="taskId" class="col-sm-4 control-label">
      Enter <code>taskId</code>
    </label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="taskId" placeholder="taskId">
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <button id="inspect-task" class="btn btn-primary">Inspect task</button>
    </div>
  </div>
</div>


<div id="task-not-found" class="alert alert-warning">
  <strong>Task Not Found!</strong> Task definition couldn't be loaded...
</div>

<div class="modal fade" id="fullscreen-log-viewer" tabindex="-1"
     role="dialog" aria-labelledby="fullscreen-log-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
          <span class="glyphicon glyphicon-remove"></span>
        </button>
        <h4 class="modal-title" id="fullscreen-log-label"></h4>
      </div>
      <div class="modal-body">
        <div id="fullscreen-log"></div>
        <div style="clear: both;"></div>
      </div>
    </div>
  </div>
</div>

<div id="task-info">
  <ul class="nav nav-tabs">
    <li class="active" data-order="-2">
      <a class="tab" data-target="#task">Task</a>
    </li>
    <li data-order="-1">
      <a class="tab" data-target="#resolution">Resolution</a>
    </li>
    <li data-order="0">
      <a class="tab" data-target="#status">Status</a>
    </li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane active" id="task">
      <h3>Task Summary</h3>
      <div id="task-summary"></div>
      <h3 class="toggle-json">
          <i class="glyphicon glyphicon-chevron-down"></i>
          <span class="json-label">Task Definition</span>
          <span class="label label-warning">json</span>
      </h3>
      <pre class="toggle-target"><code id="task-definition"></code></pre>
    </div>
    <div class="tab-pane" id="resolution">
      <h3>Resolution Summary</h3>
      <div id="resolution-summary"></div>
      <h3 class="toggle-json">
          <i class="glyphicon glyphicon-chevron-down"></i>
          <span class="json-label">Task Resolution</span>
          <span class="label label-warning">json</span>
      </h3>
      <pre class="toggle-target"><code id="task-resolution"></code></pre>
    </div>
    <div class="tab-pane" id="status">
      <h3>Status Summary</h3>
      <div id="status-summary"></div>
      <h3 class="toggle-json">
          <i class="glyphicon glyphicon-chevron-down"></i>
          <span class="json-label">Task Status</span>
          <span class="label label-warning">json</span>
      </h3>
      <pre class="toggle-target"><code id="task-status"></code></pre>
    </div>
  </div>
</div>

<script>

/** Simple hack allowing us to toggle the raw JSON */
var toggleClickHandler = function() {
    $(this).next().slideToggle(200);
    $(this).find('i').toggleClass('right');
};

// Use the toggle click handler for all .toggle-json's
$('.toggle-json').click(toggleClickHandler);

/** Simple hack implementing a tab with support disabled tabs */
var tabClickHandler = function() {
  var target = $(this).data('target');
  if ($(this).parent().hasClass('active') ||
      $(this).parent().hasClass('disabled')) {
    return;
  }
  $(this).parent().parent().parent().find('.active').removeClass('active');
  $(this).parent().addClass('active');
  $(target).addClass('active');
};

// Enable tabClickHandler for default tabs
$('.nav.nav-tabs li a.tab').click(tabClickHandler);

/** Inspect a run of the current task */
var inspectRun = function(runId) {
  // What a lovely abuse of CSS classes and event handlers :)
  $('.hit-this-show-run-' + runId).click();
};

/** Get current taskId from window hash */
var getTaskId = function() {
  return window.location.hash.substr(1);
};

/** Set current taskId when 'Inspect Task' button is clicked */
$('#inspect-task').click(function() {
  window.location.hash = '#' + $('#taskId').val();
});

/** Render a task to #definition */
var _renderTaskSummary = new EJS({url: '/assets/task-inspector/task.ejs'});
var renderTask = function(task) {
  $('#task-definition').jsonFormat(JSON.stringify(task));
  $('#task-summary').html(_renderTaskSummary.render(task));
  Prism.highlightAll(false);
};

/** Render resolution in #resolution */
var _renderResolutionSummary = new EJS({
  url: '/assets/task-inspector/resolution.ejs'
});
var renderResolution = function(resolution) {
  $('#task-resolution').jsonFormat(JSON.stringify(resolution));
  $('#resolution-summary').html(_renderResolutionSummary.render(resolution));
};

/** Render status in #status */
var _renderStatusSummary = new EJS({url: '/assets/task-inspector/status.ejs'});
var renderStatus = function(status) {
  $('#task-status').jsonFormat(JSON.stringify(status));
  $('#status-summary').html(_renderStatusSummary.render(status));
};

/** Render a log from a url to a terminal */
var renderLogInto = function(logUrl, el, options) {
  options = options ? options : {};
  var term = $(el).data('term');
  if (term) {
    term.destroy();
  }
  term = new Terminal({
    cols:         options.cols || 105,
    rows:         options.rows || 24,
    useStyle:     true,
    screenKeys:   false
  });
  term.open(el);
  $(el).data('logUrl', logUrl);
  $(el).data('term', term);
  $.get(logUrl, function(data) {
    // Abort if we started loading another log
    if ($(el).data('logUrl') != logUrl) {
      return;
    }
    term.write(data);
  }).fail(function() {
    term.write("Failed to load log from\n");
  });
};

/** Show fullscreen log */
var showFullscreenLog = function(logFile, logUrl) {
  $('#fullscreen-log-label').html("Log File: <code>" + logFile + "</code>");
  renderLogInto(logUrl, $('#fullscreen-log')[0], {
    cols:     120,
    rows:     45
  });
  $('#fullscreen-log-viewer').modal();
};

/** Create a tab for a new run and render it */
var _renderRunTab = new EJS({url: '/assets/task-inspector/run.ejs'});
var renderRunTab = function(taskId, runId, logs, result) {
  // Configure a tab
  var tab = $('<li>').append($('<a>').addClass('tab').text('Run ' + runId));
  var tabpane = $('<div>').addClass('tab-pane');
  tab.find('a').data('target', '#run-id-' + runId);
  tab.find('a').click(tabClickHandler);
  tab.find('a').addClass('hit-this-show-run-' + runId);
  tabpane.attr('id','run-id-' + runId);
  tab.data('order', runId);

  // Make it easy to clean-up
  tab.addClass('run-tab-related');
  tabpane.addClass('run-tab-related');

  // Time to populate the tabpane
  tabpane.html(_renderRunTab.render({
    taskId:   taskId,
    runId:    runId,
    logs:     logs,
    result:   result
  }));

  // Add tab and tabpane
  $('#task-info .nav.nav-tabs').append(tab);
  $('#task-info .tab-content').append(tabpane);

  // Now let sort the tabs, so there is order in this
  var tablist = $('#task-info .nav.nav-tabs');
  var tabs = tablist.children('li').get();
  tabs.sort(function(a, b) {
    return parseInt($(a).data('order')) > parseInt($(b).data('order'));
  });
  tabs.forEach(function(tab) {
    tablist.append(tab);
  });

  // Render JSON inside tabpane, if we have JSON to render
  if (result) {
    $('#run-' + runId + '-result').jsonFormat(JSON.stringify(result));
  }
  if (logs) {
    // Setup various Javascript things from the template, lovely hacks :)
    $('#run-' + runId + '-logs').jsonFormat(JSON.stringify(logs));
    $('#run-' + runId + '-log-selector').selectpicker();
    $('#run-' + runId + '-log-selector').change(function() {
      var logUrl = $('#run-' + runId + '-log-selector').val();
      renderLogInto(logUrl, $('#run-' + runId + '-term')[0]);
    });
    $('#run-' + runId + '-log-selector').change();
    $('#refresh-run-' + runId + '-log').click(function() {
      $('#run-' + runId + '-log-selector').change();
    });
    $('#fullscreen-run-' + runId + '-log').click(function() {
      var logUrl = $('#run-' + runId + '-log-selector').val();
      var label = $('#run-' + runId + '-log-selector option:selected').text();
      showFullscreenLog(label, logUrl);
    });
  }

  // Now activate click handlers and stuff
  tabpane.find('.toggle-json').click(toggleClickHandler);
  Prism.highlightAll(false);
};

/** Inspect a given taskId */
var inspectTask = function(taskId) {
  var taskId  = getTaskId();
  var baseUrl = "http://tasks.taskcluster.net/" + taskId;

  // Hide task-info while loading
  $('#task-info').hide();

  // Disable tabs until they are loaded, if they load
  $('.tab[data-target=#status]').parent().addClass('disabled');
  $('.tab[data-target=#resolution]').parent().addClass('disabled');

  // Remove all tabs and content from runs as this is regenerated
  $('.run-tab-related').remove();

  // Load task definition
  $.get(baseUrl + '/task.json', function(task) {
    // Check this is still the current task
    if (taskId != getTaskId()) {
      return;
    }
    renderTask(task);
    $('#task-not-found').hide();
    $('#task-info').show();
    // Always show the task definition tab first, other may load lazily
    $('.nav.nav-tabs li a.tab[data-target="#task"]').click();
  }).fail(function() {
    $('#task-not-found').show();
    $('#task-info').hide();
  });

  // Load task resolution
  $.get(baseUrl + '/resolution.json', function(resolution) {
    // Check this is still the current task
    if (taskId != getTaskId()) {
      return;
    }
    renderResolution(resolution);
    renderStatus(resolution.status);
    $('.tab[data-target=#resolution]').parent().removeClass('disabled');
    $('.tab[data-target=#status]').parent().removeClass('disabled');
  }).fail(function() {
    // Load task status, from queue if resolution.json is missing
    var statusUrl = 'http://queue.taskcluster.net/v1/task/' + taskId + '/status';
    $.get(statusUrl, function(status) {
      // Check this is still the current task
      if (taskId != getTaskId()) {
        return;
      }
      renderStatus(status.status);
      $('.tab[data-target=#status]').parent().removeClass('disabled');
    });
  });

  // Try to fetch runs
  [1, 2, 3, 4, 5, 6, 7, 8, 9].forEach(function(runId) {
    // Here we do a custom promise implementation because jQuery apparently
    // can't handle errors... and suffers from poor documentation.
    var unresolved = 2;
    var logs = null, result = null;
    var resolved = function() {
      if (taskId != getTaskId()) {
        return;
      }
      // If either logs or result was fetch we have something to show
      if (logs || result) {
        renderRunTab(taskId, runId, logs, result);
      }
    };
    // Do the actual requests
    $.get(baseUrl + '/runs/' + runId + '/logs.json', function(data) {
      logs = data;
      unresolved--;
      if (unresolved == 0) {
        resolved();
      }
    }).fail(function() {
      unresolved--;
      if (unresolved == 0) {
        resolved();
      }
    });
    $.get(baseUrl + '/runs/' + runId + '/result.json', function(data) {
      result = data;
      unresolved--;
      if (unresolved == 0) {
        resolved();
      }
    }).fail(function() {
      unresolved--;
      if (unresolved == 0) {
        resolved();
      }
    });
  });
};

/** On loaded, load taskId as given by window.hash */
$(function() {
  var taskId = getTaskId();
  $('#taskId').val(taskId);
  inspectTask(taskId);
});

/** When hash changes inspect the given task */
$(window).bind("hashchange", function() {
  inspectTask(getTaskId());
});
</script>

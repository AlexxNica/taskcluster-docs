---
layout:           default
class:            html
prism:            true
JSONFormatter:    true
ejs:              true
moment:           true
---

<style>
#task-not-found {display: none;}
#task-info {display: none;}
.nav.nav-tabs a.tab {
  cursor:         pointer;
}
#taskId {font: normal 10pt 'Courier New';}

.toggle-json {
  cursor: pointer;
}
.toggle-json:hover span.json-label {
  text-decoration: underline;
}
.toggle-json span.label {
  font-size: 50%;
  position: relative;
  top: -5px;
  margin-left: 5px;
}
.toggle-json i.glyphicon {
  font-size: 20px;
}
.toggle-json i.glyphicon:before {
  display:    inline-block;
  -webkit-transition: linear 200ms;
     -moz-transition: linear 200ms;
       -o-transition: linear 200ms;
          transition: linear 200ms;
  -webkit-transform: rotate(-90deg);
     -moz-transform: rotate(-90deg);
      -ms-transform: rotate(-90deg);
       -o-transform: rotate(-90deg);
          transform: rotate(-90deg);
}
.toggle-json i.glyphicon.right:before {
  -webkit-transform: rotate(0deg);
     -moz-transform: rotate(0deg);
      -ms-transform: rotate(0deg);
       -o-transform: rotate(0deg);
          transform: rotate(0deg);
}
.toggle-target {
  display:      none;
}
.link {
  cursor:       pointer;
}
</style>

<h1>Task Inspector</h1>
<p>This tool lets yo inspect a task given the <code>taskId</code></p>

<div class="form-horizontal">
  <div class="form-group">
    <label for="taskId" class="col-sm-4 control-label">
      Enter <code>taskId</code>
    </label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="taskId" placeholder="taskId">
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <button id="inspect-task" class="btn btn-primary">Inspect task</button>
    </div>
  </div>
</div>


<div id="task-not-found" class="alert alert-warning">
  <strong>Task Not Found!</strong> Task definition couldn't be loaded...
</div>

<div id="task-info">
  <ul class="nav nav-tabs">
    <li class="active"><a class="tab" data-target="#task">Task</a></li>
    <li><a class="tab" data-target="#resolution">Resolution</a></li>
    <li><a class="tab" data-target="#status">Status</a></li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane active" id="task">
      <h3>Task Summary</h3>
      <div id="task-summary"></div>
      <h3 class="toggle-json">
          <i class="glyphicon glyphicon-chevron-down"></i>
          <span class="json-label">Task Definition</span>
          <span class="label label-warning">json</span>
      </h3>
      <pre class="toggle-target"><code id="task-definition"></code></pre>
    </div>
    <div class="tab-pane" id="resolution">
      <h3>Resolution Summary</h3>
      <div id="resolution-summary"></div>
      <h3 class="toggle-json">
          <i class="glyphicon glyphicon-chevron-down"></i>
          <span class="json-label">Task Resolution</span>
          <span class="label label-warning">json</span>
      </h3>
      <pre class="toggle-target"><code id="task-resolution"></code></pre>
    </div>
    <div class="tab-pane" id="status">
      <h3>Status Summary</h3>
      <div id="status-summary"></div>
      <h3 class="toggle-json">
          <i class="glyphicon glyphicon-chevron-down"></i>
          <span class="json-label">Task Status</span>
          <span class="label label-warning">json</span>
      </h3>
      <pre class="toggle-target"><code id="task-status"></code></pre>
    </div>
  </div>
</div>

<script>
/* For testing use:
    d70dd764-c9e4-49cd-bdb7-d37613bae15e
    184663c5-d403-4dc5-9f31-ea7b973f82b1
*/

/** Simple hack allowing us to toggle the raw JSON */
$('.toggle-json').click(function() {
    $('.toggle-json').next().slideToggle(200);
    $('.toggle-json').find('i').toggleClass('right');
});

/** Simple hack implementing a tab with support disabled tabs */
$('.nav.nav-tabs li a.tab').click(function() {
  var target = $(this).data('target');
  if ($(this).parent().hasClass('active') ||
      $(this).parent().hasClass('disabled')) {
    return;
  }
  $(this).parent().parent().parent().find('.active').removeClass('active');
  $(this).parent().addClass('active');
  $(target).addClass('active');
});

/** Inspect a run of the current task */
var inspectRun = function(runId) {
  alert("TODO: Inspect runId " + runId + " of the current task!");
};

/** Get current taskId from window hash */
var getTaskId = function() {
  return window.location.hash.substr(1);
};

/** Set current taskId when 'Inspect Task' button is clicked */
$('#inspect-task').click(function() {
  window.location.hash = '#' + $('#taskId').val();
});

/** Render a task to #definition */
var _renderTaskSummary = new EJS({url: '/assets/task-inspector/task.ejs'});
var renderTask = function(task) {
  $('#task-definition').jsonFormat(JSON.stringify(task));
  $('#task-summary').html(_renderTaskSummary.render(task));
  Prism.highlightAll(false);
};

/** Render resolution in #resolution */
var _renderResolutionSummary = new EJS({
  url: '/assets/task-inspector/resolution.ejs'
});
var renderResolution = function(resolution) {
  $('#task-resolution').jsonFormat(JSON.stringify(resolution));
  $('#resolution-summary').html(_renderResolutionSummary.render(resolution));
};

/** Render status in #status */
var _renderStatusSummary = new EJS({url: '/assets/task-inspector/status.ejs'});
var renderStatus = function(status) {
  $('#task-status').jsonFormat(JSON.stringify(status));
  $('#status-summary').html(_renderStatusSummary.render(status));
};

/** Inspect a given taskId */
var inspectTask = function(taskId) {
  var taskId  = getTaskId();
  var baseUrl = "http://tasks.taskcluster.net/" + taskId;

  // Load task definition
  $.get(baseUrl + '/task.json', function(task) {
    // Check this is still the current task
    if (taskId != getTaskId()) {
      return;
    }
    renderTask(task);
    $('#task-not-found').hide();
    $('#task-info').show();
  }).fail(function() {
    $('#task-not-found').show();
    $('#task-info').hide();
  });

  // Load task resolution
  $.get(baseUrl + '/resolution.json', function(resolution) {
    // Check this is still the current task
    if (taskId != getTaskId()) {
      return;
    }
    renderResolution(resolution);
    renderStatus(resolution.status);
    $('.tab[data-target=#resolution]').parent().removeClass('disabled');
    $('.tab[data-target=#status]').parent().removeClass('disabled');
  }).fail(function() {
    $('.tab[data-target=#resolution]').parent().addClass('disabled');
    // Load task status, from queue if resolution.json is missing
    var statusUrl = 'http://queue.taskcluster.net/v1/task/' + taskId + '/status';
    $.get(statusUrl, function(status) {
      // Check this is still the current task
      if (taskId != getTaskId()) {
        return;
      }
      renderStatus(status.status);
      $('.tab[data-target=#status]').parent().removeClass('disabled');
    }).fail(function() {
      $('.tab[data-target=#status]').parent().addClass('disabled');
    });
  });

};

/** On loaded, load taskId as given by window.hash */
$(function() {
  var taskId = getTaskId();
  $('#taskId').val(taskId);
  inspectTask(taskId);
});

/** When hash changes inspect the given task */
$(window).bind("hashchange", function() {
  inspectTask(getTaskId());
});
</script>
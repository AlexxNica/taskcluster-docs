---
layout:       default
class:        markdown
docson:       true
interactive:  true
---

Creating Your First Task
========================

This tutorial will show you how to create a task, as well as how to fetch
both state and artifacts from the task. Later tutorials will show you how to
listen for the events generated by task and how to combine this with custom
routes message.


Constructing a Task Definition
------------------------------

To create a task we must construct a _task definition_, the API reference
documentation for the `queue.taskcluster.net` specifies a JSON schema for both
`queue.defineTask` and `queue.createTask` methods. You may find this schema at
`schemas.taskcluster.net/queue/v1/create-task-request.json`, for reference it
is rendered below.

<div data-render-schema="http://schemas.taskcluster.net/queue/v1/create-task-request.json#"></div>

As evident from the schema there is a few _required_ properties, such as:
`provisionerId`, `workerType`, `created`, `deadline`, `payload` and `metadata`.
The rest of the properties are optional and defaults should be documented.
It should, however, be noted that default values may change over time, so it
is recommended provide those you rely on.

All workers have a `workerType` this identifier is unique given the
`provisionerId`, hence, `provisionerId` and `workerType` uniquely identifies
the pool of workers you are submitting you task to. In practice the
`provisionerId` is embedded in scopes, such that different provisioners can
exist without interfering with each other. For the purpose of this tutorial we
shall use the `b2g-test` workerType from `aws-provisioner-v1`.

A task definition also includes a `created` timestamp, a `deadline` at which
point the _queue_ will resolve the task as `exception` unless the task has been
resolved earlier. This ensures that all tasks will eventually be resolved.
Timestamps are given in UTC as ISO 8601 formatted strings, exactly how
`Date.toJSON()` works. As evident below, `taskcluster-client` has some nice
utilities for constructing relative timestamps for this.

<pre data-plugin="interactive-example">
let taskcluster = require('taskcluster-client');

let task = {
  // Required properties
  provisionerId:      'aws-provisioner-v1',
  workerType:         'b2gtest',
  created:            (new Date()).toJSON(),
  deadline:           taskcluster.fromNowJSON('2 days 3 hours'),
  metadata: {
    // Name and description are meant to be written in markdown
    name:             "Tutorial **Example** Task",
    description:      "Task create from _interactive_ tutorials",
    // Fill in your email
    owner:            'nobody@taskcluster.net',
    // Location of task source, so we can find people with "git blame"
    source:           window.location.href
  },
  payload:            {}, // worker specific payload, we'll add it later

  // Optional properties
  expires:            taskcluster.fromNowJSON('6 months 2 days'),
  // There is more optional properties, but we don't need them here.
};

// Print example task definition
console.log(JSON.stringify(task, null, 2));
</pre>

In the example above you see how to specify the properties required by the
queue. If we were to submit this task to the queue it would be accepted,
however, the worker would immediately reject it because it doesn't carry a
valid `task.payload`. The `task.payload` is specific to the workerType given,
this way we can support multiple platforms and upgrade workers gradually.


Constructing a `task.payload` for docker-worker
-----------------------------------------------

The `b2gtest` workerType is a deployment of `docker-worker`, this worker
requires a `task.payload` that specifies which docker image to load, which
command to run and a maximum allowed runtime. You can find detailed
documentation on this site, the schema for the `task.payload` property is
located at `schemas.taskcluster.net/docker-worker/v1/payload.json`, for
reference it is rendered below.

<div data-render-schema="http://schemas.taskcluster.net/docker-worker/v1/payload.json"></div>

For the `image`


    * Schema
    * Image Ubuntu
    * Command: ls, du /
    * maxRuntime
    * artifact upload: /etc/passwd
    * minimal example



Creating a Task
---------------
    * Create a taskId (global.taskId)
    * createTask(taskId, ...) (let taskId = global.taskId)
    * Link task inspector


Fetch for Task State
--------------------
    * queue.status(global.taskId)


Download Task Artifacts
-----------------------
    * queue.listArtifacts(global.taskId, runId = 0)
    * artifactUrl = queue.buildSignedUrl(queue.getArtifact, taskId, runId)
    * artifactUrl = queue.buildUrl(queue.getArtifact, taskId, runId)
    * superagent.get(artifactUrl)


<pre data-plugin="interactive-example">
let taskcluster = require('taskcluster-client');
let slugid      = require('slugid');

// Create a queue client object w. temporary credentials
let queue = new taskcluster.Queue({
  credentials: JSON.parse(localStorage.credentials)
});

// Create new taskId (Random UUID encoded as url-safe base64)
let taskId = slugid.v4();
console.log("Generated taskId: " + taskId);

// Create task
let result = await queue.createTask(taskId, {
  provisionerId:  'aws-provisioner-v1',     // Provisioner to find worker under
  workerType:     'b2gtest',                // WorkerType to run task on
  created:        new Date().toJSON(),
  deadline:       taskcluster.fromNowJSON('2 hours'),
  payload: {                      // docker-worker specific payload
    image:        'ubuntu:15.04', // Use the ubuntu image tag 15.04
    command:      ['du', '/usr'], // Run the command 'du' with argument '/usr'
    maxRunTime:   600             // Run for at most 600s == 10min
  },
  metadata: {
    name:         "Interactive Tutorial Task",
    description:  "Task created from **interactive tutorial**...",
    owner:        "nobody@localhost.local", // Person who caused this task
    source:       window.location.href      // Source for the task definition
  }
});
console.log("Created task:\n" + JSON.stringify(result.status, null, 2));
console.log("Inspect it at: https://tools.taskcluster.net/task-inspector/#" + taskId);
</pre>


